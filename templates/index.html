<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Kubernetes Operational View</title>
        <style>* {padding: 0; margin: 0}</style>
    </head>
    <body>
        <script src="/static/pixi.min.js"></script>
<script>
//Create the renderer
const renderer = PIXI.autoDetectRenderer(256, 256);
renderer.view.style.position = "absolute";
renderer.view.style.display = "block";
renderer.autoResize = true;
renderer.resize(window.innerWidth, window.innerHeight);

//Add the canvas to the HTML document
document.body.appendChild(renderer.view);


//Create a container object called the `stage`
const stage = new PIXI.Container();

var graphics = new PIXI.Graphics();


stage.addChild(graphics);

var clusters = []

function update(clusters) {
    var tooltip = new PIXI.Graphics()
    tooltip.lineStyle(2, 0xaaaaff, 1)
    tooltip.beginFill(0x999999, 0.5)
    tooltip.drawRect(0, 0, 200, 400)
    tooltip.endFill()
    var text = new PIXI.Text('', {fontSize: 12, fill: 0xffffff})
    text.x = 2
    text.y = 2
    tooltip.addChild(text)
    tooltip.text = text
    tooltip.visible = false
    graphics.clear();
    graphics.lineStyle(2, 0xaaaaff, 1);
    var x = 50;
    for (let cluster of clusters) {
        var clusterBox = new PIXI.Graphics()
        clusterBox.x = x
        clusterBox.y = 50
        graphics.addChild(clusterBox)
        var innerX = 10;
        for (let node of cluster.nodes) {
            var nodeBox = new PIXI.Graphics()
            nodeBox.x = innerX
            nodeBox.y = 10
            nodeBox.lineStyle(2, 0xaaaaff, 1);
            nodeBox.beginFill(0x999999, 0.5)
            nodeBox.drawRect(0, 0, 100, 100)
            nodeBox.endFill()
            nodeBox.lineStyle(2, 0x00ff00, 1);
            for (var i=0; i<parseInt(node.status.capacity.cpu); i++) {
                nodeBox.drawRect(5, 5 + i * 8, 5, 5)
            }
            nodeBox.interactive = true
            nodeBox.hitArea = new PIXI.Rectangle(0, 0, 50, 50)
            nodeBox.on('mouseover', function() {
                var s = node.name
                for (let key of Object.keys(node.labels)) {
                    s += '\n' + key + ': ' + node.labels[key]
                }
                tooltip.text.text = s
                tooltip.x = this.toGlobal(new PIXI.Point(0, 0)).x
                tooltip.y = this.toGlobal(new PIXI.Point(0,0)).y
                tooltip.visible = true
            })
            nodeBox.on('mouseout', function() {
                tooltip.visible = false
            })
            var mem = parseInt(node.status.capacity.memory.replace('Ki', ''))
            nodeBox.drawRect(12, 5, 5, mem/(1024*512))
            clusterBox.addChild(nodeBox)
            var text = new PIXI.Text('', {fontSize: 10, fill: 0xffffff})
            nodeBox.addChild(text)


            var px = 20
            var py = 10
            for (let pod of node.pods) {
                var podBox = new PIXI.Graphics()
                podBox.x = px
                podBox.y = py
                if (pod.status.phase == 'Running') {
                    podBox.lineStyle(2, 0xaaffaa, 1);
                } else if (pod.status.phase == 'Pending') {
                    podBox.lineStyle(2, 0xffffaa, 1);
                } else {
                    podBox.lineStyle(2, 0xff9999, 1);
                }
                podBox.beginFill(0x999999, 0.5)
                podBox.drawRect(0, 0, 10, 10)
                nodeBox.addChild(podBox)
                px += 13
                if (px > 50) {
                    px = 20
                    py += 13
                }
            }

            innerX += nodeBox.width + 5
        }
        clusterBox.lineStyle(2, 0xaaaaff, 1);
        clusterBox.drawRect(0, 0, innerX, 200);
        x += 250;
    }
    graphics.addChild(tooltip)
}

fetch('/kubernetes-clusters')
  .then(function(response) {
     return response.json()
        })
   .then(function(json) {
       clusters = json.kubernetes_clusters;
       update(clusters)
       console.log(json);
   });

function state() {
}

function mainLoop() {
    requestAnimationFrame(mainLoop);

    state();

    //Tell the `renderer` to `render` the `stage`
    renderer.render(stage);
}

mainLoop();
</script>
    </body>

</html>
